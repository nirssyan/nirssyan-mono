apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
data:
  01-init.sql: |
    CREATE TABLE aucjp_catalog (
        vendor_id   INT NOT NULL,
        vendor_name TEXT NOT NULL,
        model_name  TEXT NOT NULL,
        lot_count   INT NOT NULL DEFAULT 0,
        updated_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
        PRIMARY KEY (vendor_id, model_name)
    );

    CREATE TABLE subscriptions (
        id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        vendor_id   INT NOT NULL,
        model_name  TEXT NOT NULL,
        slug        TEXT UNIQUE NOT NULL,
        is_active   BOOLEAN NOT NULL DEFAULT true,
        scrape_interval_min INT NOT NULL DEFAULT 30,
        last_scraped_at TIMESTAMPTZ,
        created_at  TIMESTAMPTZ NOT NULL DEFAULT now()
    );

    CREATE TABLE posts (
        id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        vendor_id   INT NOT NULL,
        model_name  TEXT NOT NULL,
        hash        TEXT NOT NULL,
        title       TEXT NOT NULL,
        link        TEXT NOT NULL DEFAULT '',
        description TEXT NOT NULL DEFAULT '',
        pub_date    TIMESTAMPTZ NOT NULL,
        extra       JSONB NOT NULL DEFAULT '{}',
        created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
        UNIQUE(vendor_id, model_name, hash)
    );

    CREATE INDEX idx_posts_model_pub ON posts(vendor_id, model_name, pub_date DESC);
