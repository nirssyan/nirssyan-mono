apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: infatium-prod

components:
  - ../../../../global/proxy-sidecar
  - ../../../../global/app-python
  - ../../../../global/worker-python
  - ../../../../global/app-go
  - ../../../../global/worker-go
  - ../../../../global/app-typescript
  - ../../../../global/worker-typescript

resources:
  - namespace.yml
  # network-policies.yml applied separately to avoid commonLabels in selectors
  - resourcequota.yml
  - limitrange.yml
  - api/ingress.yml
  - landing/ingress.yml
  - ../../base
  - ../../base/worker-bot-python
  # SealedSecrets
  - service-secrets-sealed.yml
  - auth-secrets-sealed.yml
  - bot-secrets-sealed.yml
  - redis-secrets-sealed.yml
  - postgres-secrets-sealed.yml
  - dockerhub-registry-sealed.yml
  - integrations-secrets-sealed.yml
  - minio-secrets-sealed.yml
  - proxy-credentials-sealed.yml

commonLabels:
  product: infatium
  environment: prod

images:
  # Go services
  - name: docker-registry.infrastructure:5000/go-api
    newTag: prod
  - name: docker-registry.infrastructure:5000/go-processor
    newTag: prod
  - name: docker-registry.infrastructure:5000/go-poller
    newTag: prod
  - name: docker-registry.infrastructure:5000/go-registry
    newTag: prod
  - name: docker-registry.infrastructure:5000/integrations-go
    newTag: prod
  - name: docker-registry.infrastructure:5000/auth-service
    newTag: prod
  # Python/TypeScript services
  - name: docker-registry.infrastructure:5000/makefeed-agents
    newTag: prod
  - name: docker-registry.infrastructure:5000/infatium-landing
    newTag: prod
  - name: docker-registry.infrastructure:5000/infatium-bot
    newTag: prod

patches:
  - path: worker-agents-python-patch.yml
  - path: worker-processor-go-patch.yml
  - path: worker-poller-go-patch.yml
  - path: app-registry-go-patch.yml
  - path: app-api-go-patch.yml
  - target:
      kind: Deployment
    patch: |
      - op: add
        path: /spec/template/spec/nodeSelector
        value:
          node-role: infra
      - op: add
        path: /spec/template/spec/tolerations
        value:
          - key: node-role
            operator: Equal
            value: infra
            effect: NoSchedule
      - op: add
        path: /spec/template/spec/imagePullSecrets
        value:
          - name: regcred
          - name: dockerhub-registry
  - target:
      kind: StatefulSet
    patch: |
      - op: add
        path: /spec/template/spec/nodeSelector
        value:
          node-role: infra
      - op: add
        path: /spec/template/spec/tolerations
        value:
          - key: node-role
            operator: Equal
            value: infra
            effect: NoSchedule
      - op: add
        path: /spec/template/spec/imagePullSecrets
        value:
          - name: regcred
          - name: dockerhub-registry
  - target:
      kind: Job
    patch: |
      - op: add
        path: /spec/template/spec/imagePullSecrets
        value:
          - name: regcred
          - name: dockerhub-registry
  # auth-service config for production
  - target:
      kind: ConfigMap
      name: app-auth-go-config
    patch: |
      - op: replace
        path: /data/APP_BASE_URL
        value: "https://api.infatium.ru"
      - op: replace
        path: /data/LOG_LEVEL
        value: "info"
      - op: replace
        path: /data/DEMO_MODE_ENABLED
        value: "true"
