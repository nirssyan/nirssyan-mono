apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: infatium-prod

components:
  - ../../../../global/proxy-sidecar

resources:
  - namespace.yml
  # network-policies.yml applied separately to avoid commonLabels in selectors
  - resourcequota.yml
  - limitrange.yml
  - supabase-ingress.yml
  - api/ingress.yml
  - landing/ingress.yml
  # Supabase (includes PostgreSQL)
  - ../../base/supabase
  # Infrastructure services from base
  - ../../base/nats
  - ../../base/redis
  # Python backend services
  - ../../base/app-api-python
  - ../../base/app-integrations-python
  - ../../base/worker-agents-python
  - ../../base/worker-processor-python
  - ../../base/worker-telegram-python
  - ../../base/worker-rss-python
  - ../../base/worker-web-python
  - ../../base/worker-bot-python
  # TypeScript services
  - ../../base/app-landing-typescript
  # SealedSecrets (encrypted, safe to commit)
  - service-secrets-sealed.yml
  - bot-secrets-sealed.yml
  - redis-secrets-sealed.yml
  - supabase-secrets-sealed.yml
  - dockerhub-registry-sealed.yml
  - integrations-secrets-sealed.yml

commonLabels:
  product: infatium
  environment: prod

images:
  - name: registry.infra.makekod.ru/infatium-landing
    newTag: prod
  - name: registry.infra.makekod.ru/infatium-bot
    newTag: prod
  # Python microservices - use makefeed-service:latest built by CI
  - name: registry.infra.makekod.ru/makefeed
    newName: registry.infra.makekod.ru/makefeed-service
    newTag: latest

patches:
  - target:
      kind: Deployment
    patch: |
      - op: add
        path: /spec/template/spec/nodeSelector
        value:
          node-role: infra
      - op: add
        path: /spec/template/spec/tolerations
        value:
          - key: node-role
            operator: Equal
            value: infra
            effect: NoSchedule
      - op: add
        path: /spec/template/spec/imagePullSecrets
        value:
          - name: regcred
          - name: dockerhub-registry
  - target:
      kind: Deployment
      name: supabase-studio
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/env/1/value
        value: "https://supabase.infatium.ru"
      - op: replace
        path: /spec/template/spec/containers/0/env/5/value
        value: "https://supabase.infatium.ru"
  - target:
      kind: Deployment
      name: supabase-auth
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/env/1/value
        value: "https://supabase.infatium.ru"
  - target:
      kind: StatefulSet
    patch: |
      - op: add
        path: /spec/template/spec/nodeSelector
        value:
          node-role: infra
      - op: add
        path: /spec/template/spec/tolerations
        value:
          - key: node-role
            operator: Equal
            value: infra
            effect: NoSchedule
      - op: add
        path: /spec/template/spec/imagePullSecrets
        value:
          - name: regcred
          - name: dockerhub-registry
  - target:
      kind: Job
    patch: |
      - op: add
        path: /spec/template/spec/imagePullSecrets
        value:
          - name: regcred
          - name: dockerhub-registry
  - target:
      kind: ConfigMap
      name: worker-telegram-python-config
    patch: |
      - op: replace
        path: /data/MEDIA_BASE_URL
        value: "https://api.infatium.ru"
      - op: add
        path: /data/TELEGRAM_SESSION_NAME
        value: "prod_session"
      - op: add
        path: /data/TELEGRAM_WORKDIR
        value: "/app/sessions"
  # Fix REDIS_PORT conflict with K8s auto-injected service env var
  - target:
      kind: Deployment
      name: worker-telegram-python
    patch: |
      - op: add
        path: /spec/template/spec/containers/0/env
        value:
          - name: REDIS_PORT
            value: "6379"
