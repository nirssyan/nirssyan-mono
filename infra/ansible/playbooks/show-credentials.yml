---
# Show Infrastructure Credentials
# This playbook retrieves and displays credentials from Kubernetes secrets
# Source of truth: Kubernetes secrets, NOT local files

- name: Show Infrastructure Credentials
  hosts: localhost
  gather_facts: false
  vars:
    infra_namespace: infrastructure
    kubeconfig_path: "{{ lookup('env', 'KUBECONFIG') | default(lookup('env', 'HOME') + '/.kube/nirssyan_config', true) }}"

  tasks:
    - name: Check kubectl availability
      ansible.builtin.command: kubectl version --client
      register: kubectl_check
      changed_when: false
      failed_when: false
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Fail if kubectl not available
      ansible.builtin.fail:
        msg: "kubectl is not available. Please ensure you have access to the Kubernetes cluster."
      when: kubectl_check.rc != 0

    # ============================================================
    # Docker Registry Credentials (registry-auth secret)
    # ============================================================
    - name: Get Docker Registry username
      ansible.builtin.shell: |
        kubectl get secret registry-auth -n {{ infra_namespace }} -o jsonpath='{.data.username}' | base64 -d
      register: registry_username
      changed_when: false
      failed_when: false
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Get Docker Registry password
      ansible.builtin.shell: |
        kubectl get secret registry-auth -n {{ infra_namespace }} -o jsonpath='{.data.password}' | base64 -d
      register: registry_password
      changed_when: false
      failed_when: false
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    # ============================================================
    # n8n PostgreSQL (n8n-postgres secret)
    # ============================================================
    - name: Get n8n PostgreSQL password
      ansible.builtin.shell: |
        kubectl get secret n8n-postgres -n {{ infra_namespace }} -o jsonpath='{.data.password}' | base64 -d
      register: n8n_postgres_password
      changed_when: false
      failed_when: false
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    # ============================================================
    # Infrastructure ConfigMap
    # ============================================================
    - name: Get infrastructure ConfigMap
      kubernetes.core.k8s_info:
        api_version: v1
        kind: ConfigMap
        name: infrastructure-config
        namespace: "{{ infra_namespace }}"
      register: infra_config
      failed_when: false
      when: not ansible_check_mode
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Extract config values
      ansible.builtin.set_fact:
        infra_domain: "{{ infra_config.resources[0].data.infra_domain | default('N/A') }}"
        registry_domain: "{{ infra_config.resources[0].data.registry_domain | default('N/A') }}"
      when: infra_config.resources is defined and infra_config.resources | length > 0

    # ============================================================
    # Display All Credentials
    # ============================================================
    - name: Display credentials
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘          Infrastructure Node Credentials                      â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ“‹ Configuration:"
          - "  INFRA_DOMAIN={{ infra_domain | default('N/A') }}"
          - "  REGISTRY_DOMAIN={{ registry_domain | default('N/A') }}"
          - ""
          - "ğŸ” Docker Registry (registry-auth):"
          - "  REGISTRY_USERNAME={{ registry_username.stdout | default('N/A') }}"
          - "  REGISTRY_PASSWORD={{ registry_password.stdout | default('N/A') }}"
          - ""
          - "ğŸ” n8n PostgreSQL (n8n-postgres):"
          - "  N8N_POSTGRES_PASSWORD={{ n8n_postgres_password.stdout | default('N/A') }}"
          - ""
          - "ğŸ’¡ Usage:"
          - "  1. Copy values to your own .env file"
          - "  2. Or source generated file: source .env.infra.generated"
          - "  3. Or export directly:"
          - "     export REGISTRY_USERNAME={{ registry_username.stdout | default('N/A') }}"
          - ""
          - "âš ï¸  Source of Truth: Kubernetes secrets in '{{ infra_namespace }}' namespace"
          - "    To regenerate .env file, re-run: ansible-playbook playbooks/setup-infra-node.yml"
