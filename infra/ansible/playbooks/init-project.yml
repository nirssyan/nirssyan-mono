---
# Interactive project initialization with service selection
# Usage: ansible-playbook -i inventory/hosts.yml playbooks/init-project.yml

- name: Initialize New Project (Interactive)
  hosts: localhost
  gather_facts: false

  vars_prompt:
    - name: project_name
      prompt: |
        ╔════════════════════════════════════════════════════════╗
        ║     Interactive Project Initialization                ║
        ╚════════════════════════════════════════════════════════╝

        Enter project name (lowercase, numbers, hyphens only)
      private: false

    - name: prod_domain
      prompt: "Enter production domain (e.g., myapp.com)"
      private: false

    - name: dev_domain
      prompt: "Enter development domain (default: dev.{{ prod_domain | default('myapp.com') }})\nPress Enter for default"
      private: false
      default: "dev.{{ prod_domain | default('') }}"

    - name: add_nats
      prompt: "\n═══ Service Selection ═══\n\n[1] NATS - Message broker (3-node HA cluster with JetStream)\nAdd NATS? (y/n)"
      private: false
      default: "n"

    - name: add_postgresql
      prompt: "[2] PostgreSQL - Database (single replica)\nAdd PostgreSQL? (y/n)"
      private: false
      default: "n"

    - name: add_redis
      prompt: "[3] Redis - Cache/Queue\nAdd Redis? (y/n)"
      private: false
      default: "n"

    - name: add_rabbitmq
      prompt: "[4] RabbitMQ - Message broker\nAdd RabbitMQ? (y/n)"
      private: false
      default: "n"

  tasks:
    - name: Validate project name
      ansible.builtin.assert:
        that:
          - project_name is defined
          - project_name | length > 0
          - project_name is match('^[a-z0-9-]+$')
        fail_msg: "Invalid project name. Use only lowercase letters, numbers, and hyphens."

    - name: Validate domains
      ansible.builtin.assert:
        that:
          - prod_domain is defined and prod_domain | length > 0
          - dev_domain is defined and dev_domain | length > 0
        fail_msg: "Both production and development domains are required"

    - name: Set default dev domain if empty
      ansible.builtin.set_fact:
        dev_domain: "dev.{{ prod_domain }}"
      when: dev_domain == "" or dev_domain is not defined

    - name: Build selected services list
      ansible.builtin.set_fact:
        selected_services: >-
          {{
            (add_nats | lower == 'y' or add_nats | lower == 'yes') | ternary(['nats'], []) +
            (add_postgresql | lower == 'y' or add_postgresql | lower == 'yes') | ternary(['postgresql'], []) +
            (add_redis | lower == 'y' or add_redis | lower == 'yes') | ternary(['redis'], []) +
            (add_rabbitmq | lower == 'y' or add_rabbitmq | lower == 'yes') | ternary(['rabbitmq'], [])
          }}

    - name: Configuration Summary
      ansible.builtin.debug:
        msg:
          - ""
          - "╔════════════════════════════════════════════════════════╗"
          - "║           Configuration Summary                        ║"
          - "╚════════════════════════════════════════════════════════╝"
          - ""
          - "Project:       {{ project_name }}"
          - "Production:    {{ prod_domain }}"
          - "Development:   {{ dev_domain }}"
          - ""
          - "Services ({{ selected_services | length }}):"
          - "{{ selected_services | map('regex_replace', '^(.*)$', '  - \\1') | list | join('\n') if selected_services | length > 0 else '  (none)' }}"
          - ""

    - name: Confirm configuration
      ansible.builtin.pause:
        prompt: "Continue with this configuration? Press Enter to continue, Ctrl+C to abort"

    - name: Create Kustomize project structure
      ansible.builtin.include_role:
        name: kustomize_generator
        tasks_from: create_project_structure.yml

    - name: Create production namespace manifest
      ansible.builtin.copy:
        dest: "{{ playbook_dir }}/../projects/{{ project_name }}/overlays/prod/namespace.yml"
        content: |
          apiVersion: v1
          kind: Namespace
          metadata:
            name: {{ project_name }}-prod
            labels:
              product: {{ project_name }}
              environment: prod
        mode: '0644'

    - name: Create development namespace manifest
      ansible.builtin.copy:
        dest: "{{ playbook_dir }}/../projects/{{ project_name }}/overlays/dev/namespace.yml"
        content: |
          apiVersion: v1
          kind: Namespace
          metadata:
            name: {{ project_name }}-dev
            labels:
              product: {{ project_name }}
              environment: dev
        mode: '0644'

    - name: Create production kustomization.yml
      ansible.builtin.copy:
        dest: "{{ playbook_dir }}/../projects/{{ project_name }}/overlays/prod/kustomization.yml"
        content: |
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization

          namespace: {{ project_name }}-prod

          resources:
            - namespace.yml
            - network-policies.yml
            - resourcequota.yml
            - limitrange.yml
            - ../../base

          commonLabels:
            product: {{ project_name }}
            environment: prod

          patches:
            - target:
                kind: Deployment
              patch: |
                - op: add
                  path: /spec/template/spec/nodeSelector
                  value:
                    node-role: infra
                - op: add
                  path: /spec/template/spec/tolerations
                  value:
                    - key: node-role
                      operator: Equal
                      value: infra
                      effect: NoSchedule
                - op: add
                  path: /spec/template/spec/imagePullSecrets
                  value:
                    - name: regcred
            - target:
                kind: StatefulSet
              patch: |
                - op: add
                  path: /spec/template/spec/nodeSelector
                  value:
                    node-role: infra
                - op: add
                  path: /spec/template/spec/tolerations
                  value:
                    - key: node-role
                      operator: Equal
                      value: infra
                      effect: NoSchedule
                - op: add
                  path: /spec/template/spec/imagePullSecrets
                  value:
                    - name: regcred
        mode: '0644'

    - name: Create development kustomization.yml
      ansible.builtin.copy:
        dest: "{{ playbook_dir }}/../projects/{{ project_name }}/overlays/dev/kustomization.yml"
        content: |
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization

          namespace: {{ project_name }}-dev

          resources:
            - namespace.yml
            - network-policies.yml
            - resourcequota.yml
            - limitrange.yml
            - ../../base

          commonLabels:
            product: {{ project_name }}
            environment: dev

          patches:
            - target:
                kind: Deployment
              patch: |
                - op: add
                  path: /spec/template/spec/nodeSelector
                  value:
                    node-role: infra
                - op: add
                  path: /spec/template/spec/tolerations
                  value:
                    - key: node-role
                      operator: Equal
                      value: infra
                      effect: NoSchedule
                - op: add
                  path: /spec/template/spec/imagePullSecrets
                  value:
                    - name: regcred
            - target:
                kind: StatefulSet
              patch: |
                - op: add
                  path: /spec/template/spec/nodeSelector
                  value:
                    node-role: infra
                - op: add
                  path: /spec/template/spec/tolerations
                  value:
                    - key: node-role
                      operator: Equal
                      value: infra
                      effect: NoSchedule
                - op: add
                  path: /spec/template/spec/imagePullSecrets
                  value:
                    - name: regcred
        mode: '0644'

    - name: Create base kustomization.yml
      ansible.builtin.copy:
        dest: "{{ playbook_dir }}/../projects/{{ project_name }}/base/kustomization.yml"
        content: |
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization

          resources: []
        mode: '0644'

    - name: Create NetworkPolicies for prod
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/kubernetes/network-policies.yml.j2"
        dest: "{{ playbook_dir }}/../projects/{{ project_name }}/overlays/prod/network-policies.yml"
        mode: '0644'
      vars:
        target_namespace: "{{ project_name }}-prod"

    - name: Create NetworkPolicies for dev
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/kubernetes/network-policies.yml.j2"
        dest: "{{ playbook_dir }}/../projects/{{ project_name }}/overlays/dev/network-policies.yml"
        mode: '0644'
      vars:
        target_namespace: "{{ project_name }}-dev"

    - name: Create ResourceQuota for prod
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/kubernetes/resourcequota.yml.j2"
        dest: "{{ playbook_dir }}/../projects/{{ project_name }}/overlays/prod/resourcequota.yml"
        mode: '0644'
      vars:
        target_namespace: "{{ project_name }}-prod"
        env_name: "prod"

    - name: Create ResourceQuota for dev
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/kubernetes/resourcequota.yml.j2"
        dest: "{{ playbook_dir }}/../projects/{{ project_name }}/overlays/dev/resourcequota.yml"
        mode: '0644'
      vars:
        target_namespace: "{{ project_name }}-dev"
        env_name: "dev"

    - name: Create LimitRange for prod
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/kubernetes/limitrange.yml.j2"
        dest: "{{ playbook_dir }}/../projects/{{ project_name }}/overlays/prod/limitrange.yml"
        mode: '0644'
      vars:
        target_namespace: "{{ project_name }}-prod"
        env_name: "prod"

    - name: Create LimitRange for dev
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/kubernetes/limitrange.yml.j2"
        dest: "{{ playbook_dir }}/../projects/{{ project_name }}/overlays/dev/limitrange.yml"
        mode: '0644'
      vars:
        target_namespace: "{{ project_name }}-dev"
        env_name: "dev"

    - name: Add selected services
      ansible.builtin.include_role:
        name: kustomize_generator
        tasks_from: add_service.yml
      vars:
        service_name: "{{ item }}"
        service_type: "{{ item }}"
      loop: "{{ selected_services }}"
      when: selected_services | length > 0

    - name: Update base kustomization with services
      ansible.builtin.lineinfile:
        path: "{{ playbook_dir }}/../projects/{{ project_name }}/base/kustomization.yml"
        line: "  - {{ item }}"
        insertafter: "^resources:"
      loop: "{{ selected_services }}"
      when: selected_services | length > 0

    - name: Initialization Complete
      ansible.builtin.debug:
        msg:
          - ""
          - "╔════════════════════════════════════════════════════════╗"
          - "║        ✓ Project Initialized Successfully!            ║"
          - "╚════════════════════════════════════════════════════════╝"
          - ""
          - "Project structure:"
          - "  projects/{{ project_name }}/base/         - Base manifests"
          - "  projects/{{ project_name }}/overlays/prod/ - Production config"
          - "  projects/{{ project_name }}/overlays/dev/  - Development config"
          - ""
          - "Services added:"
          - >-
            {% if selected_services | length > 0 %}
            {{ selected_services | map('regex_replace', '^(.*)$', '  - projects/' + project_name + '/base/\\1/') | list | join('\n') }}
            {% else %}
              (none)
            {% endif %}
          - ""
          - "Next steps:"
          - ""
          - "  1. Configure secrets:"
          - "     kubectl create secret generic <service>-secrets -n {{ project_name }}-dev"
          - ""
          - "  2. Deploy to Kubernetes:"
          - "     export PROJECT_NAME={{ project_name }}"
          - "     export ENVIRONMENT=dev"
          - "     ansible-playbook -i inventory/hosts.yml playbooks/deploy-project.yml"
          - ""
          - "  3. Verify deployment:"
          - "     kubectl get pods -n {{ project_name }}-dev"
          - "     kubectl get ingress -n {{ project_name }}-dev"
          - ""

    - name: NATS specific instructions
      ansible.builtin.debug:
        msg:
          - ""
          - "═══ NATS Configuration ═══"
          - ""
          - "Connection:"
          - "  - Client port:  4222"
          - "  - Monitor UI:   http://nats-{{ project_name }}-dev:8222"
          - "  - Cluster:      3-node HA with JetStream"
          - ""
          - "Test connection:"
          - "  kubectl exec -it nats-0 -n {{ project_name }}-dev -- nats-box"
          - ""
      when: "'nats' in selected_services"
