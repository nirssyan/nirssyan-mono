---
# Create Kubernetes secrets from .env file
# Usage: ansible-playbook -i inventory/hosts.yml playbooks/create-secrets.yml \
#          -e "service_name=backend" \
#          -e "namespace=product-a-prod" \
#          -e "env_file=secrets/backend-prod.env"
#
# Or with kubectl context:
# KUBECONFIG=~/.kube/nirssyan_config ansible-playbook playbooks/create-secrets.yml ...

- name: Create Kubernetes Secrets
  hosts: localhost
  gather_facts: false
  vars:
    service_name: "{{ lookup('env', 'SERVICE_NAME') }}"
    k8s_namespace: "{{ lookup('env', 'NAMESPACE') }}"
    env_file: "{{ lookup('env', 'ENV_FILE') | default('') }}"

  tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - service_name is defined and service_name | length > 0
          - k8s_namespace is defined and k8s_namespace | length > 0
        fail_msg: "SERVICE_NAME and NAMESPACE environment variables are required"

    - name: Validate env_file or prompt for manual creation
      ansible.builtin.assert:
        that:
          - env_file is defined and env_file | length > 0
        fail_msg: "ENV_FILE path is required. Example: secrets/backend-prod.env"

    - name: Check if env file exists
      ansible.builtin.stat:
        path: "{{ env_file }}"
      register: env_file_stat

    - name: Fail if env file doesn't exist
      ansible.builtin.fail:
        msg: "Env file not found: {{ env_file }}"
      when: not env_file_stat.stat.exists

    - name: Read secrets from env file
      ansible.builtin.shell:
        cmd: cat "{{ env_file }}" | grep -v '^#' | grep -v '^$' | sed 's/export //'
      register: env_contents
      changed_when: false

    - name: Parse env file into dictionary
      ansible.builtin.set_fact:
        secrets_dict: "{{ secrets_dict | default({}) | combine({item.split('=')[0]: item.split('=', 1)[1]}) }}"
      loop: "{{ env_contents.stdout_lines }}"
      when: item | length > 0 and '=' in item
      no_log: true

    - name: Check if secret already exists
      kubernetes.core.k8s_info:
        kind: Secret
        name: "{{ service_name }}-secrets"
        namespace: "{{ k8s_namespace }}"
      register: existing_secret
      when: not ansible_check_mode

    - name: Create or update Kubernetes secret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ service_name }}-secrets"
            namespace: "{{ k8s_namespace }}"
            labels:
              app: "{{ service_name }}"
              managed-by: ansible
          type: Opaque
          stringData: "{{ secrets_dict }}"
      register: secret_result
      when: not ansible_check_mode

    - name: Secret creation result
      ansible.builtin.debug:
        msg:
          - >-
            âœ“ Secret {{ service_name }}-secrets
            {{ 'updated' if (existing_secret.resources | default([])) | length > 0 else 'created' }}
            in namespace {{ k8s_namespace }}
          - "  Keys: {{ (secrets_dict | default({})).keys() | list | join(', ') }}"
          - ""
          - "To verify:"
          - "  kubectl get secret {{ service_name }}-secrets -n {{ k8s_namespace }}"
          - "  kubectl describe secret {{ service_name }}-secrets -n {{ k8s_namespace }}"
