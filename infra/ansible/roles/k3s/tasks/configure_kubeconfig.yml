---
# Configure kubeconfig for kubectl access

- name: Read k3s token (for agent nodes to use)
  ansible.builtin.slurp:
    path: /var/lib/rancher/k3s/server/node-token
  register: k3s_node_token_file
  when: k3s_mode == 'server'

- name: Store k3s token as fact
  ansible.builtin.set_fact:
    k3s_node_token: "{{ k3s_node_token_file.content | b64decode | trim }}"
  when: k3s_mode == 'server'

- name: Display k3s server info
  ansible.builtin.debug:
    msg:
      - "k3s server URL: https://{{ ansible_host }}:6443"
      - "k3s token available in k3s_node_token variable"
  when: k3s_mode == 'server'

- name: Ensure .kube directory exists
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.kube"
    state: directory
    mode: '0755'

- name: Copy kubeconfig to user directory
  ansible.builtin.copy:
    src: "{{ k3s_kubeconfig_path }}"
    dest: "{{ ansible_env.HOME }}/.kube/config"
    remote_src: true
    mode: '0600'
  when: k3s_mode == 'server'

- name: Set KUBECONFIG environment variable
  ansible.builtin.lineinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    line: "export KUBECONFIG={{ ansible_env.HOME }}/.kube/config"
    create: true
    mode: '0644'
  when: k3s_mode == 'server'
