# Supabase Service Template

Complete Supabase deployment with all core components for self-hosted Supabase instance.

## Components

This template deploys a full Supabase stack with the following services:

| Component | Image | Purpose | Port |
|-----------|-------|---------|------|
| **PostgreSQL** | `supabase/postgres:15.1.0.147` | Database with extensions | 5432 |
| **PostgREST** | `postgrest/postgrest:v11.2.2` | REST API for PostgreSQL | 3000 |
| **GoTrue (Auth)** | `supabase/gotrue:v2.99.0` | Authentication service | 9999 |
| **Realtime** | `supabase/realtime:v2.25.35` | WebSocket server | 4000 |
| **Storage API** | `supabase/storage-api:v0.40.4` | File storage service | 5000 |
| **Kong** | `kong:3.4` | API Gateway with rate limiting | 8000 |
| **Meta** | `supabase/postgres-meta:v0.68.0` | Database metadata API | 8080 |
| **Studio** | `supabase/studio:20231123-64897ce` | Web dashboard UI | 3000 |

## Prerequisites

Before deploying Supabase, ensure you have:

### Required
- ✅ Kubernetes cluster with k3s
- ✅ Persistent storage (local-path provisioner)
- ✅ Ingress controller (Traefik)
- ✅ cert-manager for SSL/TLS

### Optional (Recommended for Production)
- ⚠️ External SMTP service (SendGrid, Mailgun, AWS SES)
- ⚠️ S3-compatible storage (MinIO, AWS S3, Cloudflare R2)
- ⚠️ PostgreSQL HA setup (StackGres operator)

## Quick Start

### 1. Add Supabase to Your Project

```bash
export PROJECT_NAME=my-app
export SERVICE_NAME=supabase
export SERVICE_TYPE=supabase

ansible-playbook -i ansible/inventory/hosts.yml \
  ansible/playbooks/add-service.yml -v
```

### 2. Configure Secrets

The playbook creates `supabase-secrets` with these required variables:

```yaml
# Required - Auto-generated by Ansible
POSTGRES_PASSWORD: "auto-generated"
JWT_SECRET: "auto-generated-32-chars"
ANON_KEY: "auto-generated-jwt-token"
SERVICE_ROLE_KEY: "auto-generated-jwt-token"
DASHBOARD_USERNAME: "admin"
DASHBOARD_PASSWORD: "auto-generated"

# Optional - Configure if needed
SMTP_HOST: "smtp.example.com"
SMTP_PORT: "587"
SMTP_USER: "your-smtp-user"
SMTP_PASS: "your-smtp-password"

# Optional - Configure for S3 storage
STORAGE_BACKEND: "file"  # or "s3"
S3_REGION: "us-east-1"
S3_BUCKET: "your-bucket"
S3_ENDPOINT: "https://s3.amazonaws.com"
S3_ACCESS_KEY_ID: "your-access-key"
S3_SECRET_ACCESS_KEY: "your-secret-key"
```

### 3. Deploy to Kubernetes

```bash
export PROJECT_NAME=my-app
export ENVIRONMENT=prod  # or dev

ansible-playbook -i ansible/inventory/hosts.yml \
  ansible/playbooks/deploy-project.yml -v
```

### 4. Access Supabase Studio

After deployment, access the dashboard at:
```
https://supabase-my-app-prod.example.com
```

Login credentials are in the `supabase-secrets` Kubernetes secret.

## Architecture

### Network Flow

```
Internet
    ↓
Traefik Ingress (HTTPS)
    ↓
Kong API Gateway
    ├── /auth/v1/* → GoTrue (Auth)
    ├── /rest/v1/* → PostgREST (REST API)
    ├── /realtime/v1/* → Realtime (WebSockets)
    ├── /storage/v1/* → Storage API
    └── /pg/* → Meta (Database metadata)

Studio UI → Direct access to all services
```

### Security Features

**Kong API Gateway:**
- ✅ Rate limiting (100-200 req/min per service)
- ✅ CORS configuration
- ✅ JWT validation for protected endpoints
- ✅ Request/response logging

**Network Policies:**
- ✅ Default deny all traffic
- ✅ Explicit allow for required services
- ✅ Isolated from other namespaces

**Resource Management:**
- ✅ ResourceQuota enforced
- ✅ LimitRange with default limits
- ✅ Prevents resource exhaustion

## Configuration

### Environment Variables

All configuration via `supabase-secrets` Kubernetes secret:

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `POSTGRES_PASSWORD` | ✅ | Auto-gen | PostgreSQL password |
| `JWT_SECRET` | ✅ | Auto-gen | JWT signing secret (32+ chars) |
| `ANON_KEY` | ✅ | Auto-gen | Anonymous access JWT |
| `SERVICE_ROLE_KEY` | ✅ | Auto-gen | Service role JWT |
| `DASHBOARD_USERNAME` | ✅ | `admin` | Studio login username |
| `DASHBOARD_PASSWORD` | ✅ | Auto-gen | Studio login password |
| `SMTP_HOST` | ⚠️ | - | SMTP server hostname |
| `SMTP_PORT` | ⚠️ | `587` | SMTP server port |
| `SMTP_USER` | ⚠️ | - | SMTP username |
| `SMTP_PASS` | ⚠️ | - | SMTP password |
| `STORAGE_BACKEND` | ⚠️ | `file` | Storage backend (file/s3) |
| `S3_REGION` | ⚠️ | - | AWS region |
| `S3_BUCKET` | ⚠️ | - | S3 bucket name |
| `S3_ACCESS_KEY_ID` | ⚠️ | - | S3 access key |
| `S3_SECRET_ACCESS_KEY` | ⚠️ | - | S3 secret key |

### Resource Limits

**Default resources per component:**

| Component | CPU Request | Memory Request | CPU Limit | Memory Limit |
|-----------|-------------|----------------|-----------|--------------|
| PostgreSQL | 100m | 512Mi | 1000m | 2Gi |
| PostgREST | 100m | 256Mi | 500m | 512Mi |
| GoTrue | 50m | 128Mi | 200m | 256Mi |
| Realtime | 50m | 128Mi | 200m | 256Mi |
| Storage | 100m | 256Mi | 500m | 512Mi |
| Kong | 50m | 128Mi | 200m | 256Mi |
| Meta | 50m | 128Mi | 200m | 256Mi |
| Studio | 100m | 256Mi | 500m | 512Mi |

**Total for full stack:**
- Requests: 600m CPU, 1.8Gi Memory
- Limits: 3.1 CPU, 6Gi Memory

### Storage

**PostgreSQL:**
- PVC: `supabase-postgres-data`
- Size: 20Gi
- StorageClass: `local-path`

**Storage API:**
- PVC: `supabase-storage-data`
- Size: 50Gi
- StorageClass: `local-path`

## Production Considerations

### High Availability

**PostgreSQL HA (Recommended):**

Replace single-replica PostgreSQL with StackGres cluster:

```yaml
apiVersion: stackgres.io/v1
kind: SGCluster
metadata:
  name: supabase-postgres
spec:
  instances: 3
  postgres:
    version: '15.1'
    ssl:
      enabled: true
  configurations:
    backups:
      - sgObjectStorage: supabase-backups
        cronSchedule: "0 3 * * *"
```

**Scaling PostgREST and Auth:**

Update replica counts in `kustomization.yml` patches:

```yaml
patches:
  - target:
      kind: Deployment
      name: supabase-rest
    patch: |
      - op: replace
        path: /spec/replicas
        value: 3
```

### External Services

**SMTP (Recommended):**

Configure external SMTP for email delivery:
- SendGrid: https://sendgrid.com
- Mailgun: https://mailgun.com
- AWS SES: https://aws.amazon.com/ses/

Update `supabase-secrets` with SMTP credentials.

**S3 Storage (Recommended):**

Use external S3 for file storage:
- AWS S3
- Cloudflare R2
- MinIO (self-hosted)

Set `STORAGE_BACKEND=s3` and configure S3 credentials in `supabase-secrets`.

### Monitoring

**Metrics endpoints:**
- PostgreSQL: Port 5432 (via postgres_exporter)
- PostgREST: Port 3000 (Prometheus metrics)
- Kong: Port 8001 (Admin API)

**Grafana dashboards:**
- Supabase Overview
- PostgreSQL Performance
- API Request Rates

### Backups

**Database backups:**

```bash
# Manual backup
kubectl exec -n my-app-prod supabase-postgres-0 -- \
  pg_dump -U supabase_admin postgres > backup.sql

# Automated with CronJob
kubectl apply -f backup-cronjob.yml
```

**PV backups:**

Included in project backup playbook:

```bash
export TARGET=my-app-prod
ansible-playbook -i ansible/inventory/hosts.yml \
  ansible/playbooks/backup.yml -v
```

## Troubleshooting

### Pod Not Starting

**Check logs:**
```bash
kubectl logs -n my-app-prod deployment/supabase-rest -f
kubectl logs -n my-app-prod deployment/supabase-auth -f
```

**Common issues:**
- ❌ Missing secrets → Check `supabase-secrets` exists
- ❌ PostgreSQL not ready → Wait for DB to start
- ❌ Invalid JWT secret → Regenerate with 32+ characters

### Authentication Errors

**Check JWT secrets:**
```bash
kubectl get secret supabase-secrets -n my-app-prod -o yaml
```

**Regenerate JWT keys:**
```bash
# Generate new JWT secret
openssl rand -base64 32

# Generate new ANON_KEY
echo '{"role":"anon","iss":"supabase"}' | \
  jwt encode --secret="YOUR_JWT_SECRET" --alg=HS256

# Update secret
kubectl edit secret supabase-secrets -n my-app-prod
```

### Database Connection Issues

**Test connection:**
```bash
kubectl exec -it supabase-postgres-0 -n my-app-prod -- \
  psql -U supabase_admin -d postgres
```

**Check service DNS:**
```bash
kubectl exec -it deployment/supabase-rest -n my-app-prod -- \
  nslookup supabase-postgres
```

### Storage Issues

**Check PVC status:**
```bash
kubectl get pvc -n my-app-prod
kubectl describe pvc supabase-postgres-data -n my-app-prod
```

**Check available space:**
```bash
kubectl exec -it supabase-postgres-0 -n my-app-prod -- df -h
```

## Upgrading

### Component Versions

Update image tags in service manifests:

```bash
# Edit deployment
kubectl edit deployment supabase-rest -n my-app-prod

# Or update in source and redeploy
ansible-playbook -i ansible/inventory/hosts.yml \
  ansible/playbooks/deploy-project.yml -v
```

**Version compatibility:**
- Check [Supabase releases](https://github.com/supabase/supabase/releases)
- Test in dev environment first
- Backup database before upgrading

## API Usage

### REST API

```bash
# List tables
curl https://supabase-my-app.example.com/rest/v1/ \
  -H "apikey: YOUR_ANON_KEY"

# Query data
curl https://supabase-my-app.example.com/rest/v1/users \
  -H "apikey: YOUR_ANON_KEY"
```

### Authentication

```bash
# Sign up
curl https://supabase-my-app.example.com/auth/v1/signup \
  -H "apikey: YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"secure-password"}'
```

### Storage

```bash
# Upload file
curl -X POST https://supabase-my-app.example.com/storage/v1/object/bucket/file.png \
  -H "apikey: YOUR_ANON_KEY" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  --data-binary @file.png
```

## References

- [Supabase Documentation](https://supabase.com/docs)
- [Supabase Self-Hosting](https://supabase.com/docs/guides/self-hosting)
- [Kong Gateway](https://docs.konghq.com/)
- [PostgREST](https://postgrest.org/en/stable/)
- [GoTrue Auth](https://github.com/netlify/gotrue)

## Support

For issues specific to this template:
- Check troubleshooting section above
- Review component logs
- Consult Supabase documentation

For infrastructure issues:
- See main repository README
- Check `docs/architecture.md`
