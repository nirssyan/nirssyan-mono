apiVersion: v1
kind: ConfigMap
metadata:
  name: nats-config
  namespace: {{ project_namespace }}
  labels:
    app: nats
data:
  nats.conf: |
    # NATS Server Configuration

    # Client port
    port: 4222

    # Monitoring endpoint
    http_port: 8222

    # Server name (uses pod name for uniqueness)
    server_name: $POD_NAME

    # Cluster configuration (for HA)
    cluster {
      name: nats-cluster
      port: 6222

      # Routes for cluster discovery
      routes: [
        nats://nats-0.nats.{{ project_namespace }}.svc.cluster.local:6222
        nats://nats-1.nats.{{ project_namespace }}.svc.cluster.local:6222
        nats://nats-2.nats.{{ project_namespace }}.svc.cluster.local:6222
      ]

      # Cluster advertise address
      cluster_advertise: $CLUSTER_ADVERTISE:6222

      # Connect retries
      connect_retries: 30
    }

    # JetStream (persistent streaming)
    jetstream {
      store_dir: /data/jetstream

      # Max memory and storage
      max_memory_store: 256MB
      max_file_store: 4GB
    }

    # Limits
    max_payload: 1MB
    max_connections: 1000
    max_control_line: 4KB

    # Timeouts
    write_deadline: "10s"

    # Logging
    debug: false
    trace: false
    logtime: true
