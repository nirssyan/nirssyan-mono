name: Build and Push Image

on:
  push:
    branches:
      - web
  workflow_dispatch:

env:
  REGISTRY: registry.infra.makekod.ru
  IMAGE_NAME: makefeed-web

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}

      - name: Extract commit SHA (short)
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.sha_short }}
          build-args: |
            API_KEY=${{ secrets.API_KEY }}
            APPMETRICA_API_KEY=${{ secrets.APPMETRICA_API_KEY }}
            POSTHOG_API_KEY=${{ secrets.POSTHOG_API_KEY }}
            ENABLE_MONETIZATION=false
            ENABLE_SUBSCRIPTION=false
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: Image digest
        run: echo "Image pushed with tags latest and ${{ steps.vars.outputs.sha_short }}"

      - name: Send to n8n
        if: always()
        env:
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          AUTHOR_NAME: ${{ github.event.head_commit.author.name }}
        run: |
          jq -n \
            --arg workflow_name "${{ github.workflow }}" \
            --arg run_id "${{ github.run_id }}" \
            --arg run_number "${{ github.run_number }}" \
            --arg run_attempt "${{ github.run_attempt }}" \
            --arg run_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --arg repo_name "${{ github.event.repository.name }}" \
            --arg repo_full_name "${{ github.repository }}" \
            --arg repo_owner "${{ github.repository_owner }}" \
            --arg repo_url "${{ github.event.repository.html_url }}" \
            --arg repo_default_branch "${{ github.event.repository.default_branch }}" \
            --arg commit_message "$COMMIT_MESSAGE" \
            --arg commit_sha "${{ github.sha }}" \
            --arg commit_short_sha "${{ steps.vars.outputs.sha_short }}" \
            --arg commit_author_name "$AUTHOR_NAME" \
            --arg commit_author_email "${{ github.event.head_commit.author.email }}" \
            --arg commit_timestamp "${{ github.event.head_commit.timestamp }}" \
            --arg commit_url "${{ github.event.head_commit.url }}" \
            --arg ref_full "${{ github.ref }}" \
            --arg ref_name "${{ github.ref_name }}" \
            --arg ref_type "${{ github.ref_type }}" \
            --arg ref_head_ref "${{ github.head_ref }}" \
            --arg ref_base_ref "${{ github.base_ref }}" \
            --arg event_name "${{ github.event_name }}" \
            --arg event_action "${{ github.event.action }}" \
            --arg actor_username "${{ github.actor }}" \
            --arg actor_triggering "${{ github.triggering_actor }}" \
            --arg env_job "${{ github.job }}" \
            --arg env_runner_os "${{ runner.os }}" \
            --arg env_runner_arch "${{ runner.arch }}" \
            '{
              workflow: {
                name: $workflow_name,
                run_id: $run_id,
                run_number: $run_number,
                run_attempt: $run_attempt,
                run_url: $run_url
              },
              repository: {
                name: $repo_name,
                full_name: $repo_full_name,
                owner: $repo_owner,
                url: $repo_url,
                default_branch: $repo_default_branch
              },
              commit: {
                message: $commit_message,
                sha: $commit_sha,
                short_sha: $commit_short_sha,
                author_name: $commit_author_name,
                author_email: $commit_author_email,
                timestamp: $commit_timestamp,
                url: $commit_url
              },
              ref: {
                full: $ref_full,
                name: $ref_name,
                type: $ref_type,
                head_ref: $ref_head_ref,
                base_ref: $ref_base_ref
              },
              event: {
                name: $event_name,
                action: $event_action
              },
              actor: {
                username: $actor_username,
                triggering_actor: $actor_triggering
              },
              environment: {
                job: $env_job,
                runner_os: $env_runner_os,
                runner_arch: $env_runner_arch
              }
            }' | curl -X POST https://n8n.nirssyan.ru/webhook/github-worflow \
            -H "Content-Type: application/json" \
            -d @-
