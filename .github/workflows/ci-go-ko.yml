name: Build & Deploy Go Service (ko)

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
        description: 'Human-readable service name for notifications'
      service-path:
        required: true
        type: string
        description: 'Path to service directory (e.g. services/go-api)'
      import-path:
        required: true
        type: string
        description: 'Go import path for ko build (e.g. ./cmd/api)'
      image-name:
        required: true
        type: string
        description: 'Docker image name (e.g. go-api)'
      deployment-name:
        required: true
        type: string
        description: 'K8s deployment name'
      namespace:
        required: true
        type: string
        description: 'K8s namespace'

env:
  REGISTRY: docker-registry.infrastructure:5000

jobs:
  build-and-deploy:
    runs-on: infatium-ko
    steps:
      - name: Record job start time
        id: job_start
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: false

      - name: Record setup done time
        id: setup_done
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Install ko
        run: |
          KO_VERSION=0.17.1
          if [ ! -f "$GOPATH/bin/ko" ]; then
            go install github.com/google/ko@v${KO_VERSION}
          fi

      - name: Record ko installed time
        id: ko_done
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Configure registry auth
        run: |
          mkdir -p ~/.docker
          AUTH=$(echo -n "${{ secrets.REGISTRY_USERNAME }}:${{ secrets.REGISTRY_PASSWORD }}" | base64 -w0)
          echo "{\"auths\":{\"${{ env.REGISTRY }}\":{\"auth\":\"${AUTH}\"}}}" > ~/.docker/config.json

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build and push with ko
        env:
          KO_DOCKER_REPO: ${{ env.REGISTRY }}/${{ inputs.image-name }}
          KO_DEFAULTBASEIMAGE: alpine:3.21
          GOFLAGS: "-trimpath -buildvcs=false"
          CGO_ENABLED: "0"
        working-directory: ${{ inputs.service-path }}
        run: |
          ko build --bare --insecure-registry \
            --platform=linux/amd64 \
            --sbom=none \
            --tags=dev \
            ${{ inputs.import-path }}

      - name: Record build end time
        id: build_end
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubectl
        run: |
          kubectl config set-cluster k8s --server=https://kubernetes.default.svc --certificate-authority=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          kubectl config set-credentials sa --token=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
          kubectl config set-context default --cluster=k8s --user=sa
          kubectl config use-context default

      - name: Deploy to Kubernetes
        run: |
          kubectl rollout restart deployment/${{ inputs.deployment-name }} -n ${{ inputs.namespace }}
          kubectl rollout status deployment/${{ inputs.deployment-name }} -n ${{ inputs.namespace }} --timeout=5m

      - name: Record deploy end time
        id: deploy_end
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Send Telegram notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_DEPLOY_BOT_TOKEN }}
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            STATUS="‚úÖ"
          else
            STATUS="‚ùå"
          fi

          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -c 100 | sed 's/"/\\"/g')

          fmt_duration() {
            local d=$1
            if [[ -z "$d" ]]; then echo "N/A"; return; fi
            echo "$((d / 60))m $((d % 60))s"
          }

          JOB_START="${{ steps.job_start.outputs.time }}"
          SETUP_DONE="${{ steps.setup_done.outputs.time }}"
          KO_DONE="${{ steps.ko_done.outputs.time }}"
          BUILD_END="${{ steps.build_end.outputs.time }}"
          DEPLOY_END="${{ steps.deploy_end.outputs.time }}"

          SETUP_TIME=$(fmt_duration $((SETUP_DONE - JOB_START)))
          KO_TIME=$(fmt_duration $((KO_DONE - SETUP_DONE)))
          BUILD_TIME=$(fmt_duration $((BUILD_END - KO_DONE)))
          DEPLOY_TIME=$(fmt_duration $((DEPLOY_END - BUILD_END)))
          TOTAL_TIME=$(fmt_duration $((DEPLOY_END - JOB_START)))

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"-1002622491758\",
              \"message_thread_id\": 504,
              \"parse_mode\": \"HTML\",
              \"text\": \"${STATUS} <b>${{ inputs.service-name }} DEV</b>\n\nüì¶ Image: ${{ inputs.image-name }}:dev (ko)\nüìù Commit: ${COMMIT_MSG}\nüë§ Author: ${{ github.event.head_commit.author.name }}\n\n‚è±Ô∏è <b>–í—Ä–µ–º—è:</b>\n   Setup Go: ${SETUP_TIME}\n   Install ko: ${KO_TIME}\n   Build+Push: ${BUILD_TIME}\n   Deploy: ${DEPLOY_TIME}\n   <b>–í—Å–µ–≥–æ: ${TOTAL_TIME}</b>\"
            }"
