name: "[Dagger Pilot] go-api CI"

on:
  push:
    branches: [develop]
    paths:
      - 'services/go-api/**'
      - '.github/workflows/ci-go-api-dagger.yml'

env:
  REGISTRY: docker-registry.infrastructure:5000
  IMAGE_NAME: go-api
  IMAGE_TAG: dev-dagger

jobs:
  dagger-pipeline:
    runs-on: infatium
    steps:
      - uses: actions/checkout@v4

      - name: Test
        uses: dagger/dagger-for-github@v8.2.0
        with:
          version: "0.19.11"
          verb: call
          module: ./services/go-api/.dagger
          args: test --source=./services/go-api

      - name: Build & Export image
        uses: dagger/dagger-for-github@v8.2.0
        with:
          version: "0.19.11"
          verb: call
          module: ./services/go-api/.dagger
          args: containerize --source=./services/go-api export --path=/tmp/go-api-image.tar

      - name: Install crane
        run: |
          mkdir -p $HOME/.local/bin
          curl -sL https://github.com/google/go-containerregistry/releases/download/v0.20.3/go-containerregistry_Linux_x86_64.tar.gz | tar xz -C $HOME/.local/bin crane
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Push image to registry
        run: crane auth login "$REGISTRY" -u "${{ secrets.REGISTRY_USERNAME }}" -p "${{ secrets.REGISTRY_PASSWORD }}" --insecure && crane push /tmp/go-api-image.tar "$REGISTRY/$IMAGE_NAME:$IMAGE_TAG" --insecure

      - name: Deploy to K8s (skipped — pilot mode)
        if: false
        run: echo "Skipping deploy — pilot mode"
