name: Run DB Migrations

on:
  push:
    branches: [develop]
    paths:
      - 'database/migrations/**'
      - '.github/workflows/ci-migrations.yml'

jobs:
  migrate:
    runs-on: infatium
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install alembic psycopg2-binary

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubectl
        run: |
          kubectl config set-cluster k8s --server=https://kubernetes.default.svc --certificate-authority=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          kubectl config set-credentials sa --token=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
          kubectl config set-context default --cluster=k8s --user=sa
          kubectl config use-context default

      - name: Get DATABASE_URL
        id: db
        run: |
          DB_URL=$(kubectl get secret service-secrets -n infatium-dev -o jsonpath='{.data.DATABASE_URL}' | base64 -d)
          echo "::add-mask::${DB_URL}"
          echo "url=${DB_URL}" >> $GITHUB_OUTPUT

      - name: Stamp to sync alembic_version if needed
        working-directory: database/migrations
        env:
          DATABASE_URL: ${{ steps.db.outputs.url }}
          DB_NAMESPACE: infatium-dev
        run: |
          CURRENT=$(alembic current 2>/dev/null | grep -oP '^[a-f0-9]+' || echo "none")
          HEAD_PARENT="a1b2c3d4e5f8"
          if [ "$CURRENT" = "b2c3d4e5f6a8" ]; then
            echo "Stamping to $HEAD_PARENT (intermediate migrations already applied manually)"
            alembic stamp "$HEAD_PARENT"
          fi

      - name: Run migrations
        working-directory: database/migrations
        env:
          DATABASE_URL: ${{ steps.db.outputs.url }}
          DB_NAMESPACE: infatium-dev
        run: alembic upgrade head

      - name: Send Telegram notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_DEPLOY_BOT_TOKEN }}
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            STATUS="‚úÖ"
          else
            STATUS="‚ùå"
          fi

          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -c 100 | sed 's/"/\\"/g')

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"-1002622491758\",
              \"message_thread_id\": 504,
              \"parse_mode\": \"HTML\",
              \"text\": \"${STATUS} <b>DB Migrations DEV</b>\n\nüìù Commit: ${COMMIT_MSG}\nüë§ Author: ${{ github.event.head_commit.author.name }}\"
            }"
