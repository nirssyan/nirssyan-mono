name: Build & Deploy landing (PROD)

on:
  push:
    branches: [ master ]
    paths:
      - 'web/landing/**'
      - '.github/workflows/ci-landing-prod.yml'
  workflow_dispatch:

env:
  REGISTRY: registry.infra.makekod.ru
  IMAGE_NAME: infatium-landing

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: npm
        cache-dependency-path: web/landing/package-lock.json

    - name: Install dependencies
      working-directory: web/landing
      run: npm ci

    - name: Run lint
      working-directory: web/landing
      run: npm run lint || true

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
        password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}

    - name: Record build start time
      id: build_start
      run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./web/landing
        file: ./web/landing/Dockerfile
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:prod
        build-args: |
          NEXT_PUBLIC_API_BASE_URL=${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
          NEXT_PUBLIC_APPSTORE_URL=${{ secrets.NEXT_PUBLIC_APPSTORE_URL }}
          NEXT_PUBLIC_RUSTORE_URL=${{ secrets.NEXT_PUBLIC_RUSTORE_URL }}
          NEXT_PUBLIC_MATOMO_URL=${{ secrets.NEXT_PUBLIC_MATOMO_URL }}
          NEXT_PUBLIC_MATOMO_SITE_ID=${{ secrets.NEXT_PUBLIC_MATOMO_SITE_ID }}
          NEXT_PUBLIC_ENABLE_ANALYTICS=${{ secrets.NEXT_PUBLIC_ENABLE_ANALYTICS }}
          NEXT_PUBLIC_YANDEX_METRIKA_ID=${{ secrets.NEXT_PUBLIC_YANDEX_METRIKA_ID }}
          NEXT_PUBLIC_ENABLE_YANDEX_METRIKA=${{ secrets.NEXT_PUBLIC_ENABLE_YANDEX_METRIKA }}
          API_KEY=${{ secrets.API_KEY }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64
        provenance: false

    - name: Record build end time
      id: build_end
      run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

    - name: Setup kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'latest'

    - name: Configure kubectl
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
        chmod 600 $HOME/.kube/config

    - name: Record deploy start time
      id: deploy_start
      run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

    - name: Detect deployment name
      id: deployment_name
      run: |
        if timeout 30s kubectl get deployment app-landing-typescript -n infatium-prod --request-timeout=20s >/dev/null 2>&1; then
          echo "name=app-landing-typescript" >> $GITHUB_OUTPUT
        elif timeout 30s kubectl get deployment landing -n infatium-prod --request-timeout=20s >/dev/null 2>&1; then
          echo "name=landing" >> $GITHUB_OUTPUT
        else
          echo "No landing deployment found in namespace infatium-prod"
          timeout 30s kubectl get deployment -n infatium-prod --request-timeout=20s || true
          exit 1
        fi

    - name: Deploy to Kubernetes (prod)
      run: |
        timeout 30s kubectl rollout restart deployment/${{ steps.deployment_name.outputs.name }} -n infatium-prod --request-timeout=20s
        timeout 330s kubectl rollout status deployment/${{ steps.deployment_name.outputs.name }} -n infatium-prod --request-timeout=20s --timeout=5m

    - name: Record deploy end time
      id: deploy_end
      run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

    - name: Send Telegram notification
      if: always()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_DEPLOY_BOT_TOKEN }}
        COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
      run: |
        if [[ "${{ job.status }}" == "success" ]]; then
          STATUS="‚úÖ PROD Landing –¥–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω"
        else
          STATUS="‚ùå PROD Landing –¥–µ–ø–ª–æ–π –ø—Ä–æ–≤–∞–ª–µ–Ω"
        fi

        COMMIT_MSG=$(echo "$COMMIT_MESSAGE" | head -1 | sed 's/"/\\"/g')

        BUILD_START="${{ steps.build_start.outputs.time }}"
        BUILD_END="${{ steps.build_end.outputs.time }}"
        DEPLOY_START="${{ steps.deploy_start.outputs.time }}"
        DEPLOY_END="${{ steps.deploy_end.outputs.time }}"

        if [[ -n "$BUILD_START" && -n "$BUILD_END" ]]; then
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          BUILD_TIME="$((BUILD_DURATION / 60))m $((BUILD_DURATION % 60))s"
        else
          BUILD_TIME="N/A"
        fi

        if [[ -n "$DEPLOY_START" && -n "$DEPLOY_END" ]]; then
          DEPLOY_DURATION=$((DEPLOY_END - DEPLOY_START))
          DEPLOY_TIME="$((DEPLOY_DURATION / 60))m $((DEPLOY_DURATION % 60))s"
        else
          DEPLOY_TIME="N/A"
        fi

        if [[ -n "$BUILD_START" && -n "$DEPLOY_END" ]]; then
          TOTAL_DURATION=$((DEPLOY_END - BUILD_START))
          TOTAL_TIME="$((TOTAL_DURATION / 60))m $((TOTAL_DURATION % 60))s"
        else
          TOTAL_TIME="N/A"
        fi

        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"-1002622491758\",
            \"message_thread_id\": 239,
            \"parse_mode\": \"HTML\",
            \"disable_web_page_preview\": true,
            \"text\": \"${STATUS}\n\nüì¶ <b>–°–µ—Ä–≤–∏—Å:</b> landing\nüåê <b>–û–∫—Ä—É–∂–µ–Ω–∏–µ:</b> prod (infatium.ru)\nüìù <b>–ö–æ–º–º–∏—Ç:</b> ${COMMIT_MSG}\nüë§ <b>–ê–≤—Ç–æ—Ä:</b> ${{ github.event.head_commit.author.name }}\n\n‚è±Ô∏è <b>–í—Ä–µ–º—è:</b>\n   Build: ${BUILD_TIME}\n   Deploy: ${DEPLOY_TIME}\n   <b>–í—Å–µ–≥–æ: ${TOTAL_TIME}</b>\n\nüîó <a href=\\\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\\\">Workflow Run</a>\"
          }"
